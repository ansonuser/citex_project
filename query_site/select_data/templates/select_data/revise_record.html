{% extends "layout.html" %}
{% block left %}
<div class="card" style="margin-top:1rem">
    <div class="card-body">
        <label for="order_stock_po">庫存訂單編號</label>
        <input type="text" class="form-control" name="order_stock_po" list="order_stock_po_option">
        <datalist  id="order_stock_po_option" style="display: none;">
        </datalist>
    </div>
    <div class="card-footer">
        <div class="pull-right">
            <button class="btn-secondary btn" onclick="able_input()">選擇</button>
        </div>
    </div>
</div>
{% endblock %}
{% block content %}
<div class="card">
    <div class="card-body">
        <form method="post" class="pull-left col-md-12" id="stock_detail_form">{%csrf_token%}
            <div id="product_form">
                <div class="form-row">
                    <div class="form-group col-md-2">
                        <label for="product_number_id">商品編號:</label>
                        <input type="text" class="form-control" list="product_number_id0" name="product_number_id" disabled="disabled" onclick="addcolumn_product()">
                        
                        <datalist id="product_number_id0">
                            <option value=""></option>
                        </datalist>
                    </div>
                    <div class="form-group col-md-2">
                        <label for="product_name0">商品名稱:</label>
                        <input type="text" class="form-control" id="product_name0" disabled="disabled" required="required">
                    </div> 
                    <div class="form-group col-md-2">
                        <label for="product_po0">商品批號:</label>
                        <input type="text" class="form-control" id="product_po0" name="product_po" disabled="disabled">
                    </div>
                    <div class="form-group col-md-2">
                        <label for="valid_date0">有效日期:</label>
                        <input type="date" class="form-control" id="valid_date0" name="valid_date" disabled="disabled">
                    </div>
                    <div class="form-group col-md-2">
                        <label for="product_num" >訂貨數量:</label>
                        <input type="number" id="product_num0" name="product_num" class="form-control" disabled="disabled" value="1" min="1">
                    </div>
                    <div class="form-group col-md-2">
                        <label for="note0">備註:</label>
                        <input type="text" class="form-control" name="note" id="note0" disabled="disabled" />
                    </div>   
                </div>
            </div>
            <div class="col-sm-12 col-xs-12">
                <div class="btn-toolbar pull-right" role="toolbar" aria-label="Toolbar with button groups">
                    <div class="btn-group mr-2" role="group" style="padding-top: 1.5rem;">
                        <button type="button" class="btn btn-secondary">修改</button>
                    </div>
                    <div class="btn-group mr-2" role="group" style="padding-top: 1.5rem;">
                        <button id="submit_form" type="button" class="btn btn-secondary"  onclick="update_stock_order_detail()">新增</button>
                    </div>
                </div>
            </div>
        </form>
    </div>
</div>

           


<div class="card" style="margin-top:3rem;">
    <div class="card-fuild">
        <div class="card-body-table" >
            <h5 class="center" style="color:black">紀錄</h５>
        </div>
        <table class="table">
            <thread>
                <th scope="col">#</th>
                <th scope="col">產品</th>
                <th scope="col">有效期限</th>
                <th scope="col">庫存量</th>
                <th scope="col">已生產天數</th>
            </thread>
            <tbody>
                {% for eachform in formset%}
                    <tr>
                        <th scope="row">{{forloop.counter}}</th>
                        {% for value in eachform %}
                            <td>{{value}}</td>
                        {% endfor %}
                    </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
</div>

<div class="modal fade" tabindex="-1" role="dialog" style="display: none; padding-top: 30px;" aria-modal="true" aria-labelledby="tile" id="add_success_id">
    <div class="modal-dialog" role="document" style="border-color: black; border-width: 2px;">
        <div class="modal-content">
            <div class="modal-header" style="background:rgb(203, 203, 236) ; border-color: black;">
                <h3 class="modal-title">
                    <span class="badge badge-primary"> Info </span>
                </h3>
                <button type="button" class="close" data-dismiss="modal" aria-label="Close" onclick="close_modal()">
                    <span aria-hidden="true">&times;</span>
                </button>
            </div>
            <div class="modal-body" style="background-color: #c5dbdf; border-color: #8ba0b6; border-width: 5px;">
                <p style="font-weight: bolder;font-size: 20px; color:deepskyblue(138, 68, 68);">修改成功<br><br>
                </p>
            </div>
        </div>
    </div>
</div>

<script>


    var record = [];
    $(document).ready( function(){
        $.ajax({
            url:"{% url 'select_data:gettable'%}",
            data:{'data':'order_stock_po'},
            type:"POST",
            async:true,
            success:function(result){
                var i = 0;
                for(var key in result){
                    record[i] = key;
                    i++;
                }      
            }
        })
        $(".active").removeClass("active");
        $("#stock_bar").addClass("active");
        $("input[list='order_stock_po_option']" ).autocomplete({
            source: record
        });
    });

    function able_input(){
        var val = $("[list='order_stock_po_option']").val();
        $(record).map(function(){
            if (this == val){
                $.each($("input[disabled='disabled']"), function(){$(this).removeAttr("disabled")});
                $.each($("input[id='product_name0']"), function(){$(this).attr("disabled","disabled")});
                $("input[list='product_number_id0']").on("input", product_tree);   
                $.ajax({
                        url : "{% url 'select_data:gettable'%}",
                        type:"POST",
                        data: {'data':"product_with_stock",
                               'order_stock_po':val},
                        success:function(result){
                            for(var key in result){
                                $("#product_number_id0").append($("<option></option>").attr({"value":key}));
                            }                     
                    }
                })
            }    
        })
    }
    function product_tree(e){
        var a = e.target.value;
        var b = e.target; 
        $("#product_number_id0").find("option").filter(function(){
                                                                if((a==this.value)& a != ''){
                                                                    $.ajax({
                                                                    url:"{% url 'select_data:gettable'%}",
                                                                    type: "POST",
                                                                    data:{
                                                                        "data": "product_content", 
                                                                        "val":a
                                                                        },
                                                                    success: function(result){
                                                                            for(var key in result){
                                                                                b = b.parentNode.nextElementSibling.lastElementChild;
                                                                                var input_text = result[key];
                                                                                $(b).attr({"value":input_text})
                                                                            }
                                                                        }
                                                                    })
                                                                 }else{
                                                                    var c = e.target.parentNode.parentNode;
                                                                    $.each($(c).find("input[disabled='disabled']"), function(){$(this).removeAttr("value")})
                                                                }
                                                            })
        if (a != ""){
            $(b.parentNode.nextElementSibling.lastElementChild).attr({"required":"required"})
        }else{
            $(b.parentNode.nextElementSibling.lastElementChild).removeAttr("required")
        }
    }
    function update_stock_order_detail(){
        // console.log($("#stock_detail_form").length);
        // console.log($("#stock_detail_form").serialize());
        var a = $("input[required='required']");
        for(var i=0;i<a.length;i++){
            if (a[i].value==''){
                alert("請檢查輸入!!");
                return false;
            }
        }



        var form = $("#stock_detail_form").serialize() + "&order_stock_po=" + $("[list='order_stock_po_option']").val();
        $.ajax({
            url:'{% url "select_data:update_stock_order_detail"%}',
            data:form,
            type:'POST',
            success: function(data){
                $("#add_success_id").attr({"class":"modal fade show"}).attr({"style":"display:block; padding-top:30px;"});
                setTimeout(function(){
                    location.reload();
                }, 1000);
            }
        })
    }

    function addcolumn_product(){
      
      var current_id = document.getElementsByName("product_number_id").length;
      var new_row = $('<div class="form-group col-md-2"></div>');
      var new_label = $('<label >商品編號</label>').attr({for:'product_number_id'+current_id}); 
      var new_input = $('<input type="text" name="product_number_id" class="form-control"'+ "list=product_number_id"+current_id+'>').attr({onclick:"addcolumn_product()"});
      $(new_input).on("input", product_tree);
      var select_option = $("#product_number_id0")[0].innerHTML;
      var data_list = document.createElement("datalist");
      new_row.append(new_label, new_input, $(data_list).attr({"id":"product_number_id"+current_id}).html(select_option));

      var new_row1 = $('<div class="form-group col-md-2"></div>');
      var new_label = $('<label >商品名稱:</label>').attr({for:'product_name'+current_id});
      var new_input = $('<input type="text" disabled="disabled" class="form-control">').attr({id:'product_name'+current_id});
      new_row1.append(new_label, new_input);

      var new_row2 = $('<div class="form-group col-md-2"></div>');
      var new_label = $('<label >商品批號:</label>').attr({for:'product_po'+current_id});
      var new_input = $('<input type="text" name="product_po" class="form-control">').attr({id:'product_po'+current_id});
      new_row2.append(new_label, new_input);

      var new_row3 = $('<div class="form-group col-md-2"></div>');
      var new_label = $('<label >有效日期:</label>').attr({for:'valid_date'+current_id});
      var new_input = $('<input type="date" name="valid_date" class="form-control">').attr({id:'valid_date'+current_id});
      new_row3.append(new_label, new_input);



      var new_row4 = $('<div class="form-group col-md-2"></div>')
      var new_label = $('<label >訂貨數量:</label>').attr({for:'product_num'+current_id});
      var new_input = $('<input type="number" name="product_num" class="form-control" min="1" value="1">').attr({id:'product_num'+current_id});
      new_row4.append(new_label, new_input);


      var new_row5 = $('<div class="form-group col-md-2"></div>');
      var new_label = $('<label >備註:</label>').attr({for:'note'+current_id});
      var new_input = $('<input type="text" name="note" class="form-control">').attr({id:'note'+current_id});
      new_row5.append(new_label, new_input);

      $("#product_form").append($('<div class="form-row"></div>').append(new_row, new_row1, new_row2, new_row3, new_row4, new_row5));
      $("input[list=product_number_id"+(current_id-1)+ "]").removeAttr("onclick");
  }





</script>

{% endblock %}