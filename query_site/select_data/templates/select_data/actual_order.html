{% extends 'layout.html' %}
{% block left %}

<div class="card" style="margin-top:1rem">
    <div class="card-body">
        <label for="ask_order_no">詢價編號</label>
        <input type="text" class="form-control" name="ask_order_no" list="ask_order_no" >
        <datalist id="ask_order_no">
        </datalist>
    </div>
    <div class="card-footer">
        <div class="pull-right">
            <button class="btn-secondary btn" id="select_button" onclick="drawcontent()">查詢</button>
        </div>
    </div>
</div>

{% endblock %}
{% block content %}


    <div class="card">
        <div class="card-body">
            <form  method="post" class="pull-left col-md-12" id="insert_form"> {% csrf_token %}
                <div class="form-row">
                    <div class="form-group col-md-6">
                        <label for="order_no">訂單編號</label>
                        <input type="text" class="form-control" name="order_no">
                    </div>
                </div>
                <div class="form-row">
                    <div class="form-group col-md-3">
                        <label for="company_number_id">客戶編號</label>
                        <input type="text" class="form-control" list="company_number_id" name="company_number_id" >
                        <!-- onchange="custom_tree()" > -->
                        <datalist id="company_number_id">
                        </datalist>
                    </div>
                    <div class="form-group col-md-3">
                        <label for="company">公司</label>
                        <input type="text"class="form-control" id="company" disabled='disabled'>
                    </div>
                    <div class="form-group col-md-3">
                        <label for="site">廠區</label>
                        <input type="text" class="form-control" id="site" disabled='disabled'>
                    </div>
                    <div class="form-group col-md-3">
                        <label for="contact_window">聯絡人</label>
                        <input type="text" class="form-control" id="contact_window" disabled='disabled'>
                    </div>
                </div>

                <div class="form-row">
                    <div class="form-group col-md-4">
                        <label for="get_date">接單時間</label>
                        <input type="date" class="form-control" name="get_date">
                    </div>
                    <div class="form-group col-md-4">
                        <label for="expect_date">預計時間</label>
                        <input type="date" class="form-control" name="expect_date">
                    </div>
                    <div class="form-group col-md-4">
                        <label for="deadline">交貨期限</label>
                        <input type="date" class="form-control" name="deadline">
                    </div>

                </div>
                <div class="form-row">
                    <div class="form-group col-md-3">
                        <label for="pay_way">付款方式</label>
                        <input type="text" class="form-control" name="pay_way">
                    </div>
                    <div class="form-group col-md-3">
                        <label for="deliver_way">運送方式</label>
                        <select class="form-control" name="deliver_way">
                            <option value="自取">自取</option>
                            <option value="寄送">寄送</option>
                        </select>
                    </div>
                    <div class="form-group col-md-3">
                        <label for="invoice_condition">發票開立情形</label>
                        <select type="text" class="form-control" name="invoice_condition">
                            <option value="false">否</option>
                            <option value="true">是</option>
                        </select>
                    </div>
                    <div class="form-group col-md-3">
                        <label for="note">備註</label>
                        <input type="text" class="form-control" name="note1">
                    </div>
                </div>
                <div name="product_form">
                    <div class="form-row" name="growth_row">
                        <div class="form-group col-md-4">
                            <label for="product_number_id">商品編號</label>
                            <input type="text" class="form-control"  name="product_number_id" list="product_number_id" onclick= "addcolumn_product(0)">
                            <datalist id="product_number_id">
                            </datalist>
                        </div>
                        <div class="form-group col-md-4">
                            <label for="product_name">商品名稱</label>
                            <input type="text" class="form-control" disabled="disabled">
                        </div>
                        <div class="form-group col-md-4">
                            <label for="product_amount" >商品數量</label>
                            <input type="number" name="product_amount" class="form-control" >
                        </div>
                    </div>
                </div>
                <div class="col-md-12">
                    <div class="btn-toolbar pull-right" role="toolbar" arial-label="twbgs">
                        <div class="btn-group mr-2" role="group" style="padding-top: 1.5rem ;">
                            <button type="button" class="btn btn-secondary" id="update" onclick="add_actual()">
                                新增
                            </button>                
                        </div>
                    </div>
                </div> 
            </form>
        </div>
    </div>




<div class="card" style="margin-top:3rem;">
    <div class="card-header" style="background-color:white;">
        <h2> <span class="badge badge-secondary">歷史紀錄</span></h2>
    </div>
    <div class="card-body" style="border-style: hidden; overflow-x:auto; ">
        <div class="row" style="text-align: center; margin-bottom: .5rem;">
            <label style="float:right; margin-bottom: .5rem;vertical-align: middle;">
                修改時間為
                <select name="select_time_limit">
                    <option value="30">30</option>
                    <option value="60">60</option>
                    <option value="90">90</option>
                    <option value="180">180</option>
                    <option value="All"> All</option>
                </select>
                天內
            </label>
        </div>
        <div class="table-wrapper-scroll-y my-custom-scrollbar">
            <table class="table table-bordered table-striped mb-0" style="border-collapse: collapse;" id='actual_order_table'>
                <thead class='thead-dark'>
                    <tr>
                        <th scope="col" v-for='col in columns'>
                            [[col]]
                        </th>
                    </tr>
                </thead>
                <tbody>
                    <tr v-for='row in tableData'>
                        <td v-for='element in row'>
                            [[element]]
                        </td>
                        <td style='white-space: nowrap'>
                            <div class="btn-group mr-2" role="group">
                                <button class="btn btn-secondary" type="button" name="edit"  data-toggle="modal" data-target="#modified_table" onclick="feedinput(this)">編輯</button>
                            </div>
                        </td>
                    </tr>
                </tbody>
            </table>
        </div>
    </div>
</div>


<script>


    var table_vue = new Vue({
        delimiters: ['[[', ']]'],
        el:"#actual_order_table",
        data:{
            columns : ['詢價編號','訂單編號','客戶編號','接單時機','預計時間','交貨期限','付款方式','運送方式','備註2','商品編號','商品數量', ''],
            tableData : [],
        }
    })
    function custom_tree(e){
        custom_tree_url(e, "{% url 'select_data:gettable'%}")
    }
    
    function product_tree(e){
        product_tree_url(e, "{% url 'select_data:gettable'%}")
    }

    function renewtable(){
        var time_input = $('select[name="select_time_limit"]').val();
        $.ajax({
            url:"{% url 'select_data:gettable'%}",
            data:{'data':'renew_actual_order',
                  'limit': time_input},
            type:'POST',
            success:function(x){
                table_vue.tableData = x['form'];
            }
        })
    }  
    
    function drawcontent(){
        var a = $("input[list=ask_order_no]").val();
        $.ajax({
            url:"{% url 'select_data:gettable'%}",
            type:"POST",
            data:{
                'data':'ask_no_content',
                'val' :a,
            },
            success: function(result){
                for(var key in result){
                    if(key == "company_number_id"){
                        $(document.getElementsByName("company_number_id")[0]).val(result['company_number_id']).trigger("input");
                        // $(document.getElementsByName("company_number_id")[0])
                    }else if(key == "product_number_id"){
                        var n = result[key].length;
                        var m = document.getElementsByName(key).length-1;
                        if(n>m){
                            while(n!=m){
                                addcolumn_product(0);
                                m++;
                            }
                        }
                        for(var i=0; i<n; i++){
                            var a = $("input[list='product_number_id']")[i];
                            $(a).val(result[key][i]).on("input", product_tree).trigger("input");    
                            $(a.parentNode.parentNode.childNodes[5].lastElementChild).attr({'value':result['product_amount'][i]});
                        }
                        
                    }else{
                        var b = $("#" + key);
                        $(b).attr({"value": result[key]});
                    }
                }
            }
        })
    }
    
    function add_actual(){
        if(check_submit()){
            var ask_no = $("input[name='ask_order_no']").val();
            var form = $("#insert_form").serialize() + "&ask_no="+ask_no;
            $.ajax({
                url:"{% url 'select_data:update_actual_order'%}",
                type:"POST",
                async:true,
                data: form,
                success: function(data){

                    $("#add_success_id").attr({"class":"modal fade show"}).attr({"style":"display:block; padding-top:30px;"});
                    setTimeout(function(){
                        location.reload();
                    }, 1000);
                }
            })
        }else{
            return false;
        }
    }

    
    $(document).ready(function(){
        $('select[name="select_time_limit"]').change(renewtable)  
        renewtable();
        ask_noing( "{% url 'select_data:gettable'%}");
        companying( "{% url 'select_data:gettable'%}");
        producting( "{% url 'select_data:gettable'%}");
    
        $(".active").removeClass("active");
        $("#order_bar").addClass("active");
        $("a[href='/select_data/actual_order/']").addClass("active");

        $("input[list='company_number_id']").on("input", custom_tree);  
        $("input[list='product_number_id']").on("input", product_tree);    
});


</script>
{% endblock %}